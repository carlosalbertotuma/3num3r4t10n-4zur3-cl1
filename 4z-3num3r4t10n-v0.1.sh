#!/bin/bash
echo -e "\e[5;32m"
echo '----------------------------------------------------------------------------------------------------------------------'
echo '|  /$$$$$$                                     /$$$$$$            /$$   /$$   /$$      /$$    /$$$$$$                 |'
echo '| /$$__  $$                                   /$$__  $$          | $$  | $$  | $$    /$$$$   /$$$_  $$                |'
echo '||__/  \ $$ /$$$$$$$  /$$   /$$ /$$$$$$/$$$$ |__/  \ $$  /$$$$$$ | $$  | $$ /$$$$$$ |_  $$  | $$$$\ $$ /$$$$$$$       |'
echo '|   /$$$$$/| $$__  $$| $$  | $$| $$_  $$_  $$   /$$$$$/ /$$__  $$| $$$$$$$$|_  $$_/   | $$  | $$ $$ $$| $$__  $$      |'
echo '|  |___  $$| $$  \ $$| $$  | $$| $$ \ $$ \ $$  |___  $$| $$  \__/|_____  $$  | $$     | $$  | $$\ $$$$| $$  \ $$      |'
echo '| /$$  \ $$| $$  | $$| $$  | $$| $$ | $$ | $$ /$$  \ $$| $$            | $$  | $$ /$$ | $$  | $$ \ $$$| $$  | $$      |'
echo '||  $$$$$$/| $$  | $$|  $$$$$$/| $$ | $$ | $$|  $$$$$$/| $$            | $$  |  $$$$//$$$$$$|  $$$$$$/| $$  | $$      |'
echo '| \______/ |__/  |__/ \______/ |__/ |__/ |__/ \______/ |__/            |__/   \___/ |______/ \______/ |__/  |__/      |'
echo '| /$$   /$$                               /$$$$$$           /$$$$$$  /$$   /$$                     /$$$$$$       /$$  |'
echo '|| $$  | $$                              /$$__  $$         /$$__  $$| $$ /$$$$                    /$$$_  $$    /$$$$  |'
echo '|| $$  | $$ /$$$$$$$$ /$$   /$$  /$$$$$$|__/  \ $$        | $$  \__/| $$|_  $$         /$$    /$$| $$$$\ $$   |_  $$  |'
echo '|| $$$$$$$$|____ /$$/| $$  | $$ /$$__  $$  /$$$$$/ /$$$$$$| $$      | $$  | $$ /$$$$$$|  $$  /$$/| $$ $$ $$     | $$  |'
echo '||_____  $$   /$$$$/ | $$  | $$| $$  \__/ |___  $$|______/| $$      | $$  | $$|______/ \  $$/$$/ | $$\ $$$$     | $$  |'
echo '|      | $$  /$$__/  | $$  | $$| $$      /$$  \ $$        | $$    $$| $$  | $$          \  $$$/  | $$ \ $$$     | $$  |'
echo '|      | $$ /$$$$$$$$|  $$$$$$/| $$     |  $$$$$$/        |  $$$$$$/| $$ /$$$$$$         \  $//$$|  $$$$$$//$$ /$$$$$$|'
echo '|      |__/|________/ \______/ |__/      \______/          \______/ |__/|______/          \_/|__/ \______/|__/|______/|'
echo '----------------------------------------------------------------------------------------------------------------------'
echo -e "\e[0m"
echo ' Ps. Não Faça teste em dominio sem permissão.'
echo ' +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+'
echo ' |B|y| |-| |C|a|r|l|o|s| |T|u|m|a| |-| |B|l|4|d|s|c|4|n|'
echo ' +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+'
#-----------------------------------------------------------------------------------
sleep 3
echo -e "\e[5;32mLogar no azure-cli\e[0m"
az login --use-device-code
#-----------------------------------------------------------------------------------
echo -e "\e[5;32mEnumerando..\e[0m"
mkdir ~/AZURE-SAIDA
cd ~/AZURE-SAIDA
#-----------------------------------------------------------------------------------
echo -e "\e[5;32mEnumerando usuarios\e[0m"
az ad user list | tee -a users-azure.txt
cat  az-users.txt | grep "userPrincipalName" | grep -oh '"[^"]*"' | cut -d '"' -f2 | grep -v "userPrincipalName" | tee -a az-emails.txt
#-----------------------------------------------------------------------------------
echo -e "\e[5;32mEnumerando groups\e[0m"
az ad group list | tee -a az-groups.txt
cat ~/AZURE-SAIDA/az-groups.txt | grep displayName | grep -oh '"[^"]*"' | grep -v displayName | sort -u | tee -a az-groups-names.txt
#-----------------------------------------------------------------------------------
echo -e "\e[5;32mEnumerando apps\e[0m"
az ad app list | tee -a apps-azure.txt
#-----------------------------------------------------------------------------------
echo -e "\e[5;32mListar entidades de servico\e[0m"
az ad sp list | tee -a sp-azure.txt
az ad sp list --output=table --query='[].{Name:displayName}' --all | tee -a sp-names-azure.txt
#-----------------------------------------------------------------------------------
mkdir ~/AZURE-SAIDA/groups-users
cd ~/AZURE-SAIDA/groups-users
#-----------------------------------------------------------------------------------
echo -e "\e[5;32mEnumerando usuarios por Grupo\e[0m"
cat ~/AZURE-SAIDA/az-groups-names.txt | xargs -I@ bash -c 'az ad group member list --group "@" 2>/dev/null | tee -i "@".txt 2>/dev/null'
#-----------------------------------------------------------------------------------
#excluindo arquivos com 0k
find . -size 0k -exec rm {} \;
